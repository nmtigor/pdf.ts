{"version":3,"file":"progress.min.mjs","sources":["../../../src/addons/progress.ts"],"sourcesContent":["import type { ConfiguredMiddleware, WretchAddon, WretchResponseChain } from \"../types.js\"\n\nexport interface ProgressResolver {\n  /**\n   * Provides a way to register a callback to be invoked one or multiple times during the download.\n   * The callback receives the current progress as two arguments, the number of bytes loaded and the total number of bytes to load.\n   *\n   * _Under the hood: this method adds a middleware to the chain that will intercept the response and replace the body with a new one that will emit the progress event._\n   *\n   * ```js\n   * import ProgressAddon from \"wretch/addons/progress\"\n   *\n   * wretch(\"some_url\")\n   *   // Register the addon\n   *   .addon(ProgressAddon())\n   *   .get()\n   *   // Log the progress as a percentage of completion\n   *   .progress((loaded, total) => console.log(`${(loaded / total * 100).toFixed(0)}%`))\n   * ```\n   *\n   * @param onProgress - A callback that will be called one or multiple times with the number of bytes loaded and the total number of bytes to load.\n   */\n  progress: <T, C extends ProgressResolver, R>(\n    this: C & WretchResponseChain<T, C, R>,\n    onProgress: (loaded: number, total: number) => void\n  ) => this\n}\n\n/**\n * Adds the ability to monitor progress when downloading a response.\n *\n * _Compatible with all platforms implementing the [TransformStream WebAPI](https://developer.mozilla.org/en-US/docs/Web/API/TransformStream#browser_compatibility)._\n *\n * ```js\n * import ProgressAddon from \"wretch/addons/progress\"\n *\n * wretch(\"some_url\")\n *   // Register the addon\n *   .addon(ProgressAddon())\n *   .get()\n *   // Log the progress as a percentage of completion\n *   .progress((loaded, total) => console.log(`${(loaded / total * 100).toFixed(0)}%`))\n * ```\n */\nconst progress: () => WretchAddon<unknown, ProgressResolver> = () => {\n  function transformMiddleware(state: Record<any, any>) : ConfiguredMiddleware {\n    return next => (url, opts) => {\n      let loaded = 0\n      let total = 0\n      return next(url, opts).then(response => {\n        try {\n          const contentLength = response.headers.get(\"content-length\")\n          total = contentLength ? +contentLength : null\n          const transform = new TransformStream({\n            transform(chunk, controller) {\n              loaded += chunk.length\n              if (total < loaded) {\n                total = loaded\n              }\n              if (state.progress) {\n                state.progress(loaded, total)\n              }\n              controller.enqueue(chunk)\n            }\n          })\n          return new Response(response.body.pipeThrough(transform), response)\n        } catch (e) {\n          return response\n        }\n      })\n    }\n  }\n\n  return {\n    beforeRequest(wretch, _, state) {\n      return wretch.middlewares([transformMiddleware(state)])\n    },\n    resolver: {\n      progress(onProgress: (loaded: number, total: number) => void) {\n        this._sharedState.progress = onProgress\n        return this\n      }\n    },\n  }\n}\n\nexport default progress\n"],"names":["progress","transformMiddleware","state","next","url","opts","loaded","total","then","response","contentLength","headers","get","transform","TransformStream","chunk","controller","length","enqueue","Response","body","pipeThrough","e","beforeRequest","wretch","_","middlewares","resolver","onProgress","this","_sharedState"],"mappings":"AA4CM,MAAAA,EAAyD,KAC7D,SAASC,EAAoBC,GAC3B,OAAOC,GAAQ,CAACC,EAAKC,KACnB,IAAIC,EAAS,EACTC,EAAQ,EACZ,OAAOJ,EAAKC,EAAKC,GAAMG,MAAKC,IAC1B,IACE,MAAMC,EAAgBD,EAASE,QAAQC,IAAI,kBAC3CL,EAAQG,GAAiBA,EAAgB,KACzC,MAAMG,EAAY,IAAIC,gBAAgB,CACpCD,UAAUE,EAAOC,GACfV,GAAUS,EAAME,OACZV,EAAQD,IACVC,EAAQD,GAENJ,EAAMF,UACRE,EAAMF,SAASM,EAAQC,GAEzBS,EAAWE,QAAQH,EACpB,IAEH,OAAO,IAAII,SAASV,EAASW,KAAKC,YAAYR,GAAYJ,EAC3D,CAAC,MAAOa,GACP,OAAOb,CACR,IACD,CAEL,CAED,MAAO,CACLc,cAAa,CAACC,EAAQC,EAAGvB,IAChBsB,EAAOE,YAAY,CAACzB,EAAoBC,KAEjDyB,SAAU,CACR3B,SAAS4B,GAEP,OADAC,KAAKC,aAAa9B,SAAW4B,EACtBC,IACR,GAEJ"}